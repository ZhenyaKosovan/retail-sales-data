<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Page</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; font-size: 16px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Retail Sales Data - Diagnostic Page</h1>

    <div id="status" class="status info">
        Page loaded. Ready to test.
    </div>

    <button onclick="testDOM()">1. Test DOM Elements</button>
    <button onclick="testFunctions()">2. Test Functions Exist</button>
    <button onclick="testAPIFetch()">3. Test API Fetch</button>
    <button onclick="testFullProcess()">4. Test Full Process</button>

    <div id="output"></div>

    <script>
        const status = document.getElementById('status');
        const output = document.getElementById('output');

        function log(msg, type = 'info') {
            console.log(msg);
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.textContent = msg;
            output.appendChild(div);
        }

        function testDOM() {
            output.innerHTML = '';
            log('Testing DOM Elements...', 'info');

            const elements = {
                'retrieveBtn': document.getElementById('retrieveBtn'),
                'downloadBtn': document.getElementById('downloadBtn'),
                'spinner': document.getElementById('spinner'),
                'dataGrid': document.getElementById('dataGrid'),
                'errorMessage': document.getElementById('errorMessage')
            };

            let allFound = true;
            for (const [name, el] of Object.entries(elements)) {
                if (el) {
                    log(`✓ Found: ${name}`, 'success');
                } else {
                    log(`✗ Missing: ${name}`, 'error');
                    allFound = false;
                }
            }

            if (allFound) {
                log('✅ All DOM elements found!', 'success');
            } else {
                log('❌ Some DOM elements are missing!', 'error');
            }
        }

        function testFunctions() {
            output.innerHTML = '';
            log('Testing Functions...', 'info');

            const functions = [
                'showSpinner',
                'hideSpinner',
                'showError',
                'hideError',
                'fetchRetailSalesData',
                'parseCSVData',
                'renderDataGrid',
                'downloadData',
                'handleRetrieveData'
            ];

            let allExist = true;
            for (const funcName of functions) {
                if (typeof window[funcName] === 'function') {
                    log(`✓ Function exists: ${funcName}`, 'success');
                } else {
                    log(`✗ Function missing: ${funcName}`, 'error');
                    allExist = false;
                }
            }

            if (allExist) {
                log('✅ All functions exist!', 'success');
            } else {
                log('❌ Some functions are missing!', 'error');
            }
        }

        async function testAPIFetch() {
            output.innerHTML = '';
            log('Testing API Fetch...', 'info');

            try {
                log('Fetching metadata...', 'info');
                const response = await fetch('https://api.beta.ons.gov.uk/v1/datasets/retail-sales-index');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                log('✓ Metadata fetched successfully', 'success');
                log(`Dataset: ${data.title}`, 'info');
                log(`Last updated: ${data.last_updated}`, 'info');

                if (data.links?.latest_version) {
                    log(`✓ Latest version link found: ${data.links.latest_version.href}`, 'success');
                } else {
                    log('✗ No latest version link', 'error');
                }

                log('✅ API fetch successful!', 'success');

            } catch (error) {
                log(`❌ API fetch failed: ${error.message}`, 'error');
                log(`Error details: ${error.stack}`, 'error');
            }
        }

        async function testFullProcess() {
            output.innerHTML = '';
            log('Testing Full Data Fetch Process...', 'info');

            if (typeof fetchRetailSalesData !== 'function') {
                log('❌ fetchRetailSalesData function not found!', 'error');
                log('The app.js file may not have loaded correctly.', 'error');
                return;
            }

            try {
                log('Calling fetchRetailSalesData()...', 'info');
                const data = await fetchRetailSalesData();

                log(`✓ Data fetched: ${data.length} sectors`, 'success');

                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(data, null, 2);
                output.appendChild(pre);

                log('✅ Full process successful!', 'success');

            } catch (error) {
                log(`❌ Process failed: ${error.message}`, 'error');
                log(`Error stack:`, 'error');
                const pre = document.createElement('pre');
                pre.textContent = error.stack;
                output.appendChild(pre);
            }
        }
    </script>

    <!-- Load the actual app.js to test its functions -->
    <script src="app.js"></script>

</body>
</html>
